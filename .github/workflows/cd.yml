name: CD Pipeline

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to deploy (default: main)'
        required: false
        default: 'main'

jobs:
  cd:
    runs-on: ubuntu-latest
    steps:
      - name: Echo Inputs
        run: |
          echo ${{ inputs.branch }}

      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.branch }}

      - name: ECR Login
        uses: oyg-pf-dev-prep/github-action/ecr-login@ecr-login/v0.0.1
        with:
          repository-uri: vars.PROD_ECR_URI
          role-name: vars.PROD_GITHUB_ROLE_ARN
          
      - name: Setup Jib
        id: setup_jib
        uses: oyg-pf-dev-prep/github-action/setup-jib@setup-jib/v0.0.1

      - name: Build & Push to ECR
        run: |
          /usr/local/bin/jib build -b jib.yaml --target=${{ steps.setup_jib.outputs.repository-uri }}/sample-cicd-pub

# name: CD Pipeline

# on:
#   # push:
#   #   branches:
#   #     - main
      
#   workflow_dispatch:
#     inputs:
#       branch:
#         description: 'Branch to deploy (default: main)'
#         required: false
#         default: 'main'

# jobs:
#   input_check:
#     runs-on: ubuntu-latest
#     steps:
#       - name: echo inputs
#         run: |
#           echo ${{ inputs.branch }}

#   checkout:
#     runs-on: ubuntu-latest
#     steps:
#       - name: Checkout repository
#         uses: actions/checkout@v4
#         with:
#           ref: ${{ inputs.branch }}

#   ecr_login:
#     permissions:
#       id-token: write  # OIDC 토큰을 요청할 수 있도록 권한을 설정
#       contents: read   # actions/checkout을 위한 권한
#     uses: oyg-pf-dev-prep/github-action/.github/workflows/ecr-login-v1.yaml@main


#   build_and_push_image:
#     runs-on: ubuntu-latest
#     needs: [checkout, ecr_login]
#     steps:
#       - name: Setup Jib
#         id: setup_jib
#         uses: oyg-pf-dev-prep/github-action/.github/workflows/setup-jib-v1.yaml@main
#       - name: Build & Push to ECR
#         run: |
#           /usr/local/bin/jib build -b jib.yaml --target=${{ steps.setup_jib.outputs.repository-uri }}

